---
import DefaultLayout from '../layouts/default.astro';
import StaticEventList from '../components/StaticEventList.astro';
// import EventList from '../components/EventList.vue'; // TODO: Re-enable for progressive enhancement
import MonthNav from '../components/MonthNav.vue';

// Disable prerendering to enable SSR
export const prerender = false;

// Fetch events server-side for SSR
let eventsData = { future: [], today: [], past: [] };
let booksData = [];
// Don't fetch user info during SSR - it requires client-specific headers
// The client will fetch this on mount
let userInfo = null;

try {
  // Get the base URL for API calls
  const baseUrl = new URL(Astro.request.url).origin;
  
  // Fetch events and books in parallel (no user info during SSR)
  const [eventsResponse, booksResponse] = await Promise.all([
    fetch(`${baseUrl}/api/get-events`),
    fetch(`${baseUrl}/api/get-books`)
  ]);

  if (eventsResponse.ok) {
    eventsData = await eventsResponse.json();
  }
  if (booksResponse.ok) {
    booksData = await booksResponse.json();
  }
} catch (error) {
  console.error('Error fetching data server-side:', error);
}

---

<DefaultLayout title="Past accessibility events">
  <div class="container grid">
    <div id="events" role="region" aria-labelledby="upcoming-events-heading" class="py-l readable main-content">
      <h1 class="sr-only">Past accessibility events</h1>
      <!-- Static server-rendered content -->
      <StaticEventList 
        type="past"
        initialEvents={eventsData}
        initialBooks={booksData}
        initialUserInfo={userInfo}
      />
      
      <!-- TODO: Add progressive enhancement back once TypeScript errors are resolved -->
      <!-- 
      <EventList 
        type="past" 
        client:idle
        initialEvents={eventsData}
        initialBooks={booksData}
        initialUserInfo={userInfo}
        style="display: none;"
      />
      -->
    </div>
    <MonthNav id="month-nav" class="mb-l" client:load contentRegion='#events' />
  </div>
  <!-- End container -->
</DefaultLayout>


<style>
    #month-nav {
    display: none;
  }
  @media (min-width: 769px) {
    #month-nav {
      display: block;
    }
    .grid {
      display: grid;
      grid-template-columns: 3fr 1fr;
      gap: var(--p-space-l);
      align-items: start;
    }
  }
</style>